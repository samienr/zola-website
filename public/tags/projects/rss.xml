<?xml version="1.0" encoding="UTF-8"?>
<rss xmlns:atom="http://www.w3.org/2005/Atom" version="2.0">
    <channel>
      <title>samienr - Projects</title>
      <link>https://samienr.com</link>
      <description>Electrical Nerd + Digital Artist</description>
      <generator>Zola</generator>
      <language>en</language>
      <atom:link href="https://samienr.com/tags/projects/rss.xml" rel="self" type="application/rss+xml"/>
      <lastBuildDate>Fri, 19 Dec 2025 00:00:00 +0000</lastBuildDate>
      <item>
          <title>Designing a CPU From Scratch, Part 2: Fundamental Components</title>
          <pubDate>Fri, 19 Dec 2025 00:00:00 +0000</pubDate>
          <author>Samien Rahman</author>
          <link>https://samienr.com/blog/designing-a-cpu-02/</link>
          <guid>https://samienr.com/blog/designing-a-cpu-02/</guid>
          <description xml:base="https://samienr.com/blog/designing-a-cpu-02/">&lt;h1 id=&quot;arithmetic-logic-unit-alu&quot;&gt;Arithmetic Logic Unit (ALU)&lt;&#x2F;h1&gt;
&lt;p&gt;After skimming through the RV32I instruction set, I figured I could start with
the arithmetic logic unit (ALU). The ALU is where most actual computations happen.
Its composition depends on what operations it needs to perform. For RV32I,
these are the operations I will need to implement for a functional ALU:&lt;&#x2F;p&gt;
&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;Instruction&lt;&#x2F;th&gt;&lt;th&gt;ALU Unit Needed&lt;&#x2F;th&gt;&lt;&#x2F;tr&gt;&lt;&#x2F;thead&gt;&lt;tbody&gt;
&lt;tr&gt;&lt;td&gt;&lt;code&gt;add&lt;&#x2F;code&gt;, &lt;code&gt;addi&lt;&#x2F;code&gt;&lt;&#x2F;td&gt;&lt;td&gt;Adder&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;code&gt;sub&lt;&#x2F;code&gt;, &lt;code&gt;slt&lt;&#x2F;code&gt;, &lt;code&gt;sltu&lt;&#x2F;code&gt;&lt;&#x2F;td&gt;&lt;td&gt;Subtractor&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;code&gt;slli&lt;&#x2F;code&gt;, &lt;code&gt;srli&lt;&#x2F;code&gt;, &lt;code&gt;srai&lt;&#x2F;code&gt;, &lt;code&gt;sll&lt;&#x2F;code&gt;, &lt;code&gt;sra&lt;&#x2F;code&gt;, &lt;code&gt;srl&lt;&#x2F;code&gt;&lt;&#x2F;td&gt;&lt;td&gt;Shifter&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;code&gt;and&lt;&#x2F;code&gt;, &lt;code&gt;or&lt;&#x2F;code&gt;, &lt;code&gt;xor&lt;&#x2F;code&gt;, &lt;code&gt;andi&lt;&#x2F;code&gt;, &lt;code&gt;ori&lt;&#x2F;code&gt;, &lt;code&gt;xori&lt;&#x2F;code&gt;&lt;&#x2F;td&gt;&lt;td&gt;Primitive logic gates&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;&#x2F;tbody&gt;&lt;&#x2F;table&gt;
&lt;p&gt;Our design will simply have circuitry to compute all these operations and
then multiplex out whatever an &lt;code&gt;ALU_Op&lt;&#x2F;code&gt; control signal requests.&lt;&#x2F;p&gt;
&lt;p&gt;I&#x27;m aware that there are some other instructions that do math, such as
&lt;code&gt;auipc&lt;&#x2F;code&gt; and &lt;code&gt;lui&lt;&#x2F;code&gt;. These operations will use their own dedicated
hardware outside of the ALU.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;condition-codes-flags&quot;&gt;Condition Codes&#x2F;Flags&lt;&#x2F;h2&gt;
&lt;p&gt;In addition to the operations, our machine also needs to generate condition
flags. RV32I doesn&#x27;t really define how we will handle whether branches are
taken or not, so how we approach this is up to us. The simplest approach
I found was only checking for three conditions:&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;Is our result zero?&lt;&#x2F;li&gt;
&lt;li&gt;Is A &amp;lt; B? (unsigned)&lt;&#x2F;li&gt;
&lt;li&gt;Is A &amp;lt; B? (signed)&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;p&gt;We can easily use the results of the subtractor for these signals. Every type of branch instruction we will need to consider can be resolved using these three conditions.&lt;&#x2F;p&gt;
&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;Instruction&lt;&#x2F;th&gt;&lt;th&gt;Logical Condition&lt;&#x2F;th&gt;&lt;th&gt;ALU Signal&lt;&#x2F;th&gt;&lt;&#x2F;tr&gt;&lt;&#x2F;thead&gt;&lt;tbody&gt;
&lt;tr&gt;&lt;td&gt;beq&lt;&#x2F;td&gt;&lt;td&gt;A == B&lt;&#x2F;td&gt;&lt;td&gt;Zero&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;bne&lt;&#x2F;td&gt;&lt;td&gt;A != B&lt;&#x2F;td&gt;&lt;td&gt;NOT Zero&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;bltu&lt;&#x2F;td&gt;&lt;td&gt;A &amp;lt; B (unsigned)&lt;&#x2F;td&gt;&lt;td&gt;A &amp;lt; B (unsigned)&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;bgeu&lt;&#x2F;td&gt;&lt;td&gt;A &amp;gt;= B (unsigned)&lt;&#x2F;td&gt;&lt;td&gt;NOT A &amp;lt; B (unsigned)&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;blt&lt;&#x2F;td&gt;&lt;td&gt;A &amp;lt; B (signed)&lt;&#x2F;td&gt;&lt;td&gt;A &amp;lt; B (signed)&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;bge&lt;&#x2F;td&gt;&lt;td&gt;A &amp;gt;= B (signed)&lt;&#x2F;td&gt;&lt;td&gt;NOT A &amp;lt; B (signed)&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;&#x2F;tbody&gt;&lt;&#x2F;table&gt;
&lt;p&gt;The &lt;code&gt;zero&lt;&#x2F;code&gt; condition will simply check if A and B are equal to each other.&lt;br &#x2F;&gt;
The less than (unsigned) condition &lt;code&gt;ltU&lt;&#x2F;code&gt; will be computed by subtracting
&lt;code&gt;A - B&lt;&#x2F;code&gt; and taking the complement of the subtractor&#x27;s borrow bit.&lt;br &#x2F;&gt;
The less than (signed) condition &lt;code&gt;lt&lt;&#x2F;code&gt; will use the same subtractor and
result. Its value will come from the &lt;code&gt;XOR&lt;&#x2F;code&gt; of the subtractor&#x27;s borrow
bit and another signal that indicates whether or not the subtractor had overflow.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;alu-code&quot;&gt;ALU Code&lt;&#x2F;h2&gt;
&lt;pre data-lang=&quot;verilog&quot; style=&quot;background-color:#212733;color:#ccc9c2;&quot; class=&quot;language-verilog &quot;&gt;&lt;code class=&quot;language-verilog&quot; data-lang=&quot;verilog&quot;&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;module &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;ALU&lt;&#x2F;span&gt;&lt;span&gt;(
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#5ccfe6;&quot;&gt;    input&lt;&#x2F;span&gt;&lt;span&gt; [&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;31&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;] &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;A&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#5ccfe6;&quot;&gt;    input&lt;&#x2F;span&gt;&lt;span&gt; [&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;31&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;] &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;B&lt;&#x2F;span&gt;&lt;span&gt;,
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#5ccfe6;&quot;&gt;    input&lt;&#x2F;span&gt;&lt;span&gt; [&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;3&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;] ALU_Op,
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#5ccfe6;&quot;&gt;output &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;reg&lt;&#x2F;span&gt;&lt;span&gt; [&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;31&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;] Result,
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#5ccfe6;&quot;&gt;    output&lt;&#x2F;span&gt;&lt;span&gt; zero, lt, ltU
&lt;&#x2F;span&gt;&lt;span&gt;    );
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;wire&lt;&#x2F;span&gt;&lt;span&gt; [&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;32&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;] sub_full &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;= {&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;1&amp;#39;b0&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;A&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;} - {&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;1&amp;#39;b0&lt;&#x2F;span&gt;&lt;span&gt;, &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;B&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;}&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;wire&lt;&#x2F;span&gt;&lt;span&gt; sub_overflow &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span&gt; (&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;A&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;31&lt;&#x2F;span&gt;&lt;span&gt;] &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;^ &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;B&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;31&lt;&#x2F;span&gt;&lt;span&gt;]) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt; (sub_full[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;31&lt;&#x2F;span&gt;&lt;span&gt;] &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;^ &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;A&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;31&lt;&#x2F;span&gt;&lt;span&gt;]);
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;assign&lt;&#x2F;span&gt;&lt;span&gt; zero &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;A &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;== &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;B&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;assign&lt;&#x2F;span&gt;&lt;span&gt; lt  &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span&gt; sub_full[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;31&lt;&#x2F;span&gt;&lt;span&gt;] &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;^&lt;&#x2F;span&gt;&lt;span&gt; sub_overflow;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;assign&lt;&#x2F;span&gt;&lt;span&gt; ltU &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;= ~&lt;&#x2F;span&gt;&lt;span&gt;sub_full[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;32&lt;&#x2F;span&gt;&lt;span&gt;];
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;always &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;@&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;*&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;begin
&lt;&#x2F;span&gt;&lt;span&gt;Result &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;32&amp;#39;b0&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;case&lt;&#x2F;span&gt;&lt;span&gt; (ALU_Op)
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;`ALU_ADD&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span&gt;       Result &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;A &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;+ &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;B&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;`ALU_SUB&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span&gt;       Result &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span&gt; sub_full[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;31&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;];
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;`ALU_SHF_L&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span&gt;     Result &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;A &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;&amp;lt;&amp;lt; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;B&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;4&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;];
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;`ALU_SHF_R_L&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span&gt;   Result &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;A &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;&amp;gt;&amp;gt; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;B&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;4&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;];
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;`ALU_SHF_R_A&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span&gt;   Result &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f28779;&quot;&gt;$signed&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;A&lt;&#x2F;span&gt;&lt;span&gt;) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;&amp;gt;&amp;gt;&amp;gt; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;B&lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;4&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;];
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;`ALU_AND&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span&gt;       Result &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;A &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;&amp;amp; &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;B&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;`ALU_OR&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span&gt;        Result &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;A &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;| &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;B&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;`ALU_XOR&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span&gt;       Result &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;A &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;^ &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;B&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;`ALU_PASSB&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span&gt;     Result &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;B&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;`ALU_SLT&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span&gt;       Result &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;= {{&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;31&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;{&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;1&amp;#39;b0&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;}}&lt;&#x2F;span&gt;&lt;span&gt;, lt&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;}&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;`ALU_SLTU&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span&gt;      Result &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;= {{&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;31&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;{&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;1&amp;#39;b0&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;}}&lt;&#x2F;span&gt;&lt;span&gt;, ltU&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;}&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;default&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span&gt;        Result &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;A&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;endcase
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;end
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;endmodule
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h1 id=&quot;register-file&quot;&gt;Register File&lt;&#x2F;h1&gt;
&lt;p&gt;This is one of the most trivial yet most important components to make.
Since we won&#x27;t be doing anything superscalar or out-of-order just yet,
we can get away with writing a very simple register file with just two
read ports and one write port. Our ISA tells us that we have 32 registers
with 32 bits each. Since reading doesn&#x27;t change state, we can make that
part combinational and save some time. However, since writing does change
state, it must be synchronized, so changes will only be made on rising
clock edges. Other than that, the only thing we need to keep in mind is
that the x0 register (address 0b00000) is always 0, and writing to it
makes no changes.&lt;&#x2F;p&gt;
&lt;p&gt;&lt;strong&gt;EDIT:&lt;&#x2F;strong&gt; Looks like I missed something here. Since this machine is going
to be pipelined, we need to account for the case where one register is being
written by one instruction, but is simultaneously being read by a future
instruction in an earlier phase of the pipeline. In this case, the value
that is being written must be forwarded to the next instruction, &lt;em&gt;not&lt;&#x2F;em&gt; the
value that was there before. To fix this, all we need is the ability to
directly output what is being written if the destination register happens
to be one of the source registers.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;register-file-code&quot;&gt;Register File Code&lt;&#x2F;h2&gt;
&lt;pre data-lang=&quot;verilog&quot; style=&quot;background-color:#212733;color:#ccc9c2;&quot; class=&quot;language-verilog &quot;&gt;&lt;code class=&quot;language-verilog&quot; data-lang=&quot;verilog&quot;&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;module &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;RegFile&lt;&#x2F;span&gt;&lt;span&gt;(
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#5ccfe6;&quot;&gt;    input&lt;&#x2F;span&gt;&lt;span&gt; clk,
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#5ccfe6;&quot;&gt;    input&lt;&#x2F;span&gt;&lt;span&gt; [&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;4&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;] rs1,
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#5ccfe6;&quot;&gt;    input&lt;&#x2F;span&gt;&lt;span&gt; [&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;4&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;] rs2,
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#5ccfe6;&quot;&gt;    input&lt;&#x2F;span&gt;&lt;span&gt; we,
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#5ccfe6;&quot;&gt;    input&lt;&#x2F;span&gt;&lt;span&gt; [&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;4&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;] wr_addr,
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#5ccfe6;&quot;&gt;    input&lt;&#x2F;span&gt;&lt;span&gt; [&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;31&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;] wr_data,
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#5ccfe6;&quot;&gt;    output&lt;&#x2F;span&gt;&lt;span&gt; [&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;31&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;] rd1,
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#5ccfe6;&quot;&gt;    output&lt;&#x2F;span&gt;&lt;span&gt; [&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;31&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;] rd2
&lt;&#x2F;span&gt;&lt;span&gt;    );
&lt;&#x2F;span&gt;&lt;span&gt;    
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;    reg&lt;&#x2F;span&gt;&lt;span&gt; [&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;31&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;] registers[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;31&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;];
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;always &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;@&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;posedge&lt;&#x2F;span&gt;&lt;span&gt; clk)
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;if&lt;&#x2F;span&gt;&lt;span&gt; (we &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;&amp;amp;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt; wr_addr &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;!= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;5&amp;#39;b0&lt;&#x2F;span&gt;&lt;span&gt;)
&lt;&#x2F;span&gt;&lt;span&gt;            registers[wr_addr] &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;&amp;lt;=&lt;&#x2F;span&gt;&lt;span&gt; wr_data;
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;assign&lt;&#x2F;span&gt;&lt;span&gt; rd1 &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span&gt; (rs1 &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;== &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;? &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;32&amp;#39;b0 &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#5c6773;&quot;&gt;&#x2F;&#x2F; read x0
&lt;&#x2F;span&gt;&lt;span&gt;                 (rs1 &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;==&lt;&#x2F;span&gt;&lt;span&gt; wr_addr &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;&amp;amp;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt; we) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;?&lt;&#x2F;span&gt;&lt;span&gt; wr_data &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#5c6773;&quot;&gt;&#x2F;&#x2F; bypass
&lt;&#x2F;span&gt;&lt;span&gt;                 registers[rs1]; &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#5c6773;&quot;&gt;&#x2F;&#x2F; normal read
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;assign&lt;&#x2F;span&gt;&lt;span&gt; rd2 &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span&gt; (rs2 &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;== &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;? &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;32&amp;#39;b0 &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;                 (rs2 &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;==&lt;&#x2F;span&gt;&lt;span&gt; wr_addr &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;&amp;amp;&amp;amp;&lt;&#x2F;span&gt;&lt;span&gt; we) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;?&lt;&#x2F;span&gt;&lt;span&gt; wr_data &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;                 registers[rs2];
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;endmodule
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h1 id=&quot;program-counter-pc&quot;&gt;Program Counter (PC)&lt;&#x2F;h1&gt;
&lt;p&gt;Even more trivial than the register file is the PC. The PC is a simple 32-bit register
that can be updated every cycle. In real hardware, this would be driven by some reset
logic or a boot ROM.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;pc-code&quot;&gt;PC Code&lt;&#x2F;h2&gt;
&lt;pre data-lang=&quot;verilog&quot; style=&quot;background-color:#212733;color:#ccc9c2;&quot; class=&quot;language-verilog &quot;&gt;&lt;code class=&quot;language-verilog&quot; data-lang=&quot;verilog&quot;&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;module &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;PC&lt;&#x2F;span&gt;&lt;span&gt;(
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#5ccfe6;&quot;&gt;    input&lt;&#x2F;span&gt;&lt;span&gt; clk,
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#5ccfe6;&quot;&gt;    input&lt;&#x2F;span&gt;&lt;span&gt; we,
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#5ccfe6;&quot;&gt;    input&lt;&#x2F;span&gt;&lt;span&gt; [&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;31&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;] in,
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#5ccfe6;&quot;&gt;    output&lt;&#x2F;span&gt;&lt;span&gt; [&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;31&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;] out
&lt;&#x2F;span&gt;&lt;span&gt;    );
&lt;&#x2F;span&gt;&lt;span&gt;    
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;    reg&lt;&#x2F;span&gt;&lt;span&gt; [&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;31&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;] counter;
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;initial&lt;&#x2F;span&gt;&lt;span&gt; counter &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;32&amp;#39;h8000_0000&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;assign&lt;&#x2F;span&gt;&lt;span&gt; out &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;=&lt;&#x2F;span&gt;&lt;span&gt; counter;
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;always &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;@&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;posedge&lt;&#x2F;span&gt;&lt;span&gt; clk)
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;if&lt;&#x2F;span&gt;&lt;span&gt; (we) counter &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;&amp;lt;=&lt;&#x2F;span&gt;&lt;span&gt; in;
&lt;&#x2F;span&gt;&lt;span&gt;    
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;endmodule
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h1 id=&quot;memory&quot;&gt;Memory&lt;&#x2F;h1&gt;
&lt;p&gt;Even though RISC-V architecturally has instruction and data memory unified,
I&#x27;m going to keep instructions and data separate in hardware as it makes
pipelining much less of a headache. They&#x27;re usually cached separately in
most machines anyways.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;instructions&quot;&gt;Instructions&lt;&#x2F;h2&gt;
&lt;p&gt;We will make the instruction memory behave like a synchronous ROM.
We&#x27;ll also ensure that it is only word addressable.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;verilog&quot; style=&quot;background-color:#212733;color:#ccc9c2;&quot; class=&quot;language-verilog &quot;&gt;&lt;code class=&quot;language-verilog&quot; data-lang=&quot;verilog&quot;&gt;&lt;span style=&quot;font-style:italic;color:#5c6773;&quot;&gt;&#x2F;&#x2F; TODO: Add simulated delay
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;module &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;InstructionMemory&lt;&#x2F;span&gt;&lt;span&gt;(
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#5ccfe6;&quot;&gt;    input&lt;&#x2F;span&gt;&lt;span&gt; clk,
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#5ccfe6;&quot;&gt;    input&lt;&#x2F;span&gt;&lt;span&gt; [&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;31&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;] addr,
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#5ccfe6;&quot;&gt;output &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;reg&lt;&#x2F;span&gt;&lt;span&gt; [&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;31&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;] instruction
&lt;&#x2F;span&gt;&lt;span&gt;    );
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;    reg&lt;&#x2F;span&gt;&lt;span&gt; [&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;31&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;] mem [&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;1023&lt;&#x2F;span&gt;&lt;span&gt;]; &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#5c6773;&quot;&gt;&#x2F;&#x2F; 4KB Instruction Memory (1024 words)
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#5c6773;&quot;&gt;&#x2F;&#x2F; TODO: load test program    
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#5c6773;&quot;&gt;&#x2F;&#x2F;    initial $readmemh(&amp;quot;program.hex&amp;quot;, mem);
&lt;&#x2F;span&gt;&lt;span&gt;
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;always &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;@&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;posedge&lt;&#x2F;span&gt;&lt;span&gt; clk)
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#5c6773;&quot;&gt;&#x2F;&#x2F; chop off last two bits to ensure word aligned
&lt;&#x2F;span&gt;&lt;span&gt;        instruction &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;&amp;lt;=&lt;&#x2F;span&gt;&lt;span&gt; mem[addr[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;11&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;2&lt;&#x2F;span&gt;&lt;span&gt;]];
&lt;&#x2F;span&gt;&lt;span&gt;        
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;endmodule
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h2 id=&quot;data&quot;&gt;Data&lt;&#x2F;h2&gt;
&lt;p&gt;Data memory is a little more complicated as we need to be able to operate on
bytes, halfwords, and words for stores. I&#x27;m just going to model this internally
as an array of 8-bit registers. The input and output will be in terms of words,
and a &lt;code&gt;byte_en&lt;&#x2F;code&gt; signal will determine how many bytes are actually going into memory.&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;verilog&quot; style=&quot;background-color:#212733;color:#ccc9c2;&quot; class=&quot;language-verilog &quot;&gt;&lt;code class=&quot;language-verilog&quot; data-lang=&quot;verilog&quot;&gt;&lt;span style=&quot;font-style:italic;color:#5c6773;&quot;&gt;&#x2F;&#x2F; word aligned accesses only from core&amp;#39;s POV, internally byte addresable
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;module &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;DMem&lt;&#x2F;span&gt;&lt;span&gt;(
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#5ccfe6;&quot;&gt;    input&lt;&#x2F;span&gt;&lt;span&gt; clk,
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#5ccfe6;&quot;&gt;    input&lt;&#x2F;span&gt;&lt;span&gt; we,
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#5ccfe6;&quot;&gt;    input&lt;&#x2F;span&gt;&lt;span&gt; [&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;3&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;] byte_en,
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#5ccfe6;&quot;&gt;    input&lt;&#x2F;span&gt;&lt;span&gt; [&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;31&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;] addr,
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#5ccfe6;&quot;&gt;    input&lt;&#x2F;span&gt;&lt;span&gt; [&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;31&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;] din,
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#5ccfe6;&quot;&gt;output &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;reg&lt;&#x2F;span&gt;&lt;span&gt; [&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;31&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;] dout,
&lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#5ccfe6;&quot;&gt;    output&lt;&#x2F;span&gt;&lt;span&gt; ready
&lt;&#x2F;span&gt;&lt;span&gt;    );
&lt;&#x2F;span&gt;&lt;span&gt;    
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;assign&lt;&#x2F;span&gt;&lt;span&gt; ready &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;= &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;1&amp;#39;b1&lt;&#x2F;span&gt;&lt;span&gt;; &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#5c6773;&quot;&gt;&#x2F;&#x2F; TODO: simulate delay
&lt;&#x2F;span&gt;&lt;span&gt;    
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;    reg&lt;&#x2F;span&gt;&lt;span&gt; [&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;7&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;] mem[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;4095&lt;&#x2F;span&gt;&lt;span&gt;]; &lt;&#x2F;span&gt;&lt;span style=&quot;font-style:italic;color:#5c6773;&quot;&gt;&#x2F;&#x2F; 4KB addressable
&lt;&#x2F;span&gt;&lt;span&gt;    
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;always &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;@&lt;&#x2F;span&gt;&lt;span&gt;(&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;posedge&lt;&#x2F;span&gt;&lt;span&gt; clk) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;begin
&lt;&#x2F;span&gt;&lt;span&gt;        dout &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;&amp;lt;= {&lt;&#x2F;span&gt;&lt;span&gt;mem[addr[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;11&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;] &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;+ &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;3&lt;&#x2F;span&gt;&lt;span&gt;], 
&lt;&#x2F;span&gt;&lt;span&gt;                 mem[addr[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;11&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;] &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;+ &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;2&lt;&#x2F;span&gt;&lt;span&gt;], 
&lt;&#x2F;span&gt;&lt;span&gt;                 mem[addr[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;11&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;] &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;+ &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;1&lt;&#x2F;span&gt;&lt;span&gt;], 
&lt;&#x2F;span&gt;&lt;span&gt;                 mem[addr[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;11&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;]]&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;}&lt;&#x2F;span&gt;&lt;span&gt;;
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;if&lt;&#x2F;span&gt;&lt;span&gt; (we) &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;begin
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;if&lt;&#x2F;span&gt;&lt;span&gt; (byte_en[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;]) mem[addr[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;11&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;]] &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;&amp;lt;=&lt;&#x2F;span&gt;&lt;span&gt; din[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;7&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;];
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;if&lt;&#x2F;span&gt;&lt;span&gt; (byte_en[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;1&lt;&#x2F;span&gt;&lt;span&gt;]) mem[addr[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;11&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;] &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;+ &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;1&lt;&#x2F;span&gt;&lt;span&gt;] &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;&amp;lt;=&lt;&#x2F;span&gt;&lt;span&gt; din[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;15&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;8&lt;&#x2F;span&gt;&lt;span&gt;];
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;if&lt;&#x2F;span&gt;&lt;span&gt; (byte_en[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;2&lt;&#x2F;span&gt;&lt;span&gt;]) mem[addr[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;11&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;] &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;+ &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;2&lt;&#x2F;span&gt;&lt;span&gt;] &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;&amp;lt;=&lt;&#x2F;span&gt;&lt;span&gt; din[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;23&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;16&lt;&#x2F;span&gt;&lt;span&gt;];
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;if&lt;&#x2F;span&gt;&lt;span&gt; (byte_en[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;3&lt;&#x2F;span&gt;&lt;span&gt;]) mem[addr[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;11&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;] &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;+ &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;3&lt;&#x2F;span&gt;&lt;span&gt;] &lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;&amp;lt;=&lt;&#x2F;span&gt;&lt;span&gt; din[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;31&lt;&#x2F;span&gt;&lt;span style=&quot;color:#f29e74;&quot;&gt;:&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;24&lt;&#x2F;span&gt;&lt;span&gt;];
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;end
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;end
&lt;&#x2F;span&gt;&lt;span&gt;    
&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffa759;&quot;&gt;endmodule
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;h1 id=&quot;what-s-next&quot;&gt;What&#x27;s Next?&lt;&#x2F;h1&gt;
&lt;p&gt;Now we have the most basic components, we are ready to think about how we
will decode instructions and wire the datapath. That will involve creating
the control signals, logic relating to control signals, smaller intermediate
components depending on what instructions need, and the pipeline registers.
After we do that, all that should be left is hazard control, handling
branches, and testing.&lt;&#x2F;p&gt;
&lt;p&gt;For now, feel free to take a look at the
&lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;samienr&#x2F;risc-v-toy&quot;&gt;source HDL code I have so far on my GitHub.&lt;&#x2F;a&gt;
Until then, take care!&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>Designing a CPU From Scratch, Part 1: ISA</title>
          <pubDate>Sun, 26 Oct 2025 00:00:00 +0000</pubDate>
          <author>Samien Rahman</author>
          <link>https://samienr.com/blog/designing-a-cpu-01/</link>
          <guid>https://samienr.com/blog/designing-a-cpu-01/</guid>
          <description xml:base="https://samienr.com/blog/designing-a-cpu-01/">&lt;p&gt;I&#x27;ve been wanting to practice my understanding of computer architecture ever since I completed &lt;a href=&quot;https:&#x2F;&#x2F;users.ece.utexas.edu&#x2F;~patt&#x2F;24f.460n&#x2F;&quot;&gt;this course&lt;&#x2F;a&gt; during my studies. However, I didn&#x27;t know Verilog at the time, so the most I could do was a cycle-accurate pipelined &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;samienr&#x2F;ECE460N&#x2F;tree&#x2F;main&#x2F;lab6&#x2F;submission&quot;&gt;simulator&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;The goal is to take this project to the next level: &lt;strong&gt;I&#x27;m going to make a synthesizable pipelined RISC-V core in RTL.&lt;&#x2F;strong&gt; The goal is simple: create a pipelined, in-order processor that can execute RV32I instructions.&lt;&#x2F;p&gt;
&lt;p&gt;After I get some basic functionality, I will try to implement support for interrupts&#x2F;exceptions. Then I&#x27;ll explore caches, branch prediction, and out-of-order execution.&lt;&#x2F;p&gt;
&lt;h1 id=&quot;instruction-set-architecture&quot;&gt;Instruction Set Architecture&lt;&#x2F;h1&gt;
&lt;p&gt;The instruction set architecture (ISA) is the contract between hardware and software, meaning it defines how instructions are encoded, what registers exist, and what operations a CPU can perform. It is &lt;strong&gt;not&lt;&#x2F;strong&gt; the implementation details. In other words, it defines &lt;em&gt;what&lt;&#x2F;em&gt; the CPU can do, but doesn&#x27;t dictate &lt;em&gt;how.&lt;&#x2F;em&gt;&lt;&#x2F;p&gt;
&lt;p&gt;Choosing the ISA is a &lt;em&gt;very significant&lt;&#x2F;em&gt; decision as it affects the CPUs fundamental design, and everything that builds on it. This includes instruction encoding, register file, and memory.&lt;&#x2F;p&gt;
&lt;p&gt;Since the primary purpose of this project is the learning experience, I figured using the RV32I instruction set is a no-brainer. The abundance of resources due to RISC-V&#x27;s open-source nature makes it a natural choice for such a learning exercise.&lt;&#x2F;p&gt;
&lt;p&gt;With that in mind, I can start designing the individual logical components of the processor. I don&#x27;t have the entire thing planned out yet, but I&#x27;m going to begin with the following components, then continue with whatever makes the most sense:&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;ALU&lt;&#x2F;li&gt;
&lt;li&gt;Register file&lt;&#x2F;li&gt;
&lt;li&gt;Decoder + control signals&lt;&#x2F;li&gt;
&lt;li&gt;We&#x27;ll figure it out as we go&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;p&gt;Once I get everything working, I&#x27;ll try to get this running on an FPGA.&lt;&#x2F;p&gt;
&lt;p&gt;I&#x27;m optimistic I can get this done within a few months, but Murphy&#x27;s Law &lt;em&gt;is&lt;&#x2F;em&gt; very much a thing.&lt;&#x2F;p&gt;
</description>
      </item>
      <item>
          <title>How I Designed My First Custom Keyboard</title>
          <pubDate>Fri, 14 Jun 2024 00:00:00 +0000</pubDate>
          <author>Samien Rahman</author>
          <link>https://samienr.com/blog/keyboard/</link>
          <guid>https://samienr.com/blog/keyboard/</guid>
          <description xml:base="https://samienr.com/blog/keyboard/">&lt;p&gt;I&#x27;ve been into custom mechanical keyboards for a while, but the absurdly high costs and long wait times for parts pushed me towards a different solution: designing and building a keyboard myself. As a college student, affordability and quick access are key, and the custom keyboard is just the opposite of that, so I decided to take on this project myself.&lt;&#x2F;p&gt;
&lt;p&gt;I figured if I were going to design the keyboard entirely myself, I might as well make it as &lt;em&gt;custom&lt;&#x2F;em&gt; as possible. I was going to design this keyboard something &lt;em&gt;just for myself&lt;&#x2F;em&gt;.&lt;&#x2F;p&gt;
&lt;h1 id=&quot;design&quot;&gt;Design&lt;&#x2F;h1&gt;
&lt;p&gt;Within a few weeks of &lt;a href=&quot;https:&#x2F;&#x2F;reddit.com&#x2F;r&#x2F;ErgoMechKeyboards&quot;&gt;snooping around online&lt;&#x2F;a&gt;, I discovered a whole world of bizarrely-shaped, split keyboards. I very quickly became inspired by the &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;kata0510&#x2F;Lily58&quot;&gt;Lily58&lt;&#x2F;a&gt; and the &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;foostan&#x2F;crkbd&quot;&gt;Corne&lt;&#x2F;a&gt;. I learned that the  motivation behind these strange layouts came from two goals that I had myself:&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;Reducing finger movement&lt;&#x2F;li&gt;
&lt;li&gt;Enhanced typing comfort&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;p&gt;Both of these goals are achieved by two design choices:&lt;&#x2F;p&gt;
&lt;ol&gt;
&lt;li&gt;Less keys = less places for my fingers to go&lt;&#x2F;li&gt;
&lt;li&gt;Key placement matching the natural positioning of fingers meaning a split layout&lt;&#x2F;li&gt;
&lt;&#x2F;ol&gt;
&lt;p&gt;To start, I mapped out a rough layout by tracing my finger movements using a painting app on an iPad.

	&lt;img class=&quot;
			
			
			
			no-hover
                        
		&quot;
		alt=&quot;Traced finger positions&quot;
		src=&quot;finger_paint.png&quot; &#x2F;&gt;
	

&lt;&#x2F;p&gt;
&lt;figcaption&gt;Super basic, I know.&lt;&#x2F;figcaption&gt;
&lt;p&gt;That gave a basic idea of the where each finger naturally goes as I extend them.&lt;&#x2F;p&gt;
&lt;p&gt;As for hardware, I chose:&lt;&#x2F;p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Seeed Studio XIAO nRF52840&lt;&#x2F;strong&gt; microcontroller for its Bluetooth Low Energy capability, affordable price, and ARM architecture.&lt;&#x2F;li&gt;
&lt;li&gt;&lt;strong&gt;Kalih Choc Red switches&lt;&#x2F;strong&gt; for their low profile and because I like linear switches&lt;&#x2F;li&gt;
&lt;&#x2F;ul&gt;
&lt;hr &#x2F;&gt;
&lt;h1 id=&quot;ergogen&quot;&gt;Ergogen&lt;&#x2F;h1&gt;
&lt;p&gt;I needed a tool to design the layout and found &lt;a href=&quot;https:&#x2F;&#x2F;ergogen.cache.works&#x2F;&quot;&gt;Ergogen&lt;&#x2F;a&gt;. , which uses a simple YAML format to create layouts. Thanks to &lt;a href=&quot;https:&#x2F;&#x2F;flatfootfox.com&#x2F;ergogen-introduction&#x2F;&quot;&gt;a helpful blog series by FlatFootFox&lt;&#x2F;a&gt;, I defined a 3x6 grid for keys on each hand, matching the finger positions I had determined on the iPad. The flexibility of YAML allowed me to easily tweak the layout until it felt and looked right. Here&#x27;s a snippet of my Ergogen config:&lt;&#x2F;p&gt;
&lt;pre data-lang=&quot;yaml&quot; style=&quot;background-color:#212733;color:#ccc9c2;&quot; class=&quot;language-yaml &quot;&gt;&lt;code class=&quot;language-yaml&quot; data-lang=&quot;yaml&quot;&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;columns&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;outer&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;          &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;key&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;splay&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;10
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;pinky&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;          &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;key&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;stagger&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;3
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;ring&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;          &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;key&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;stagger&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;8
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;splay&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;-4&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;1
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;spread&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bae67e;&quot;&gt;1.035kx
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;middle&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;          &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;key&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;stagger&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bae67e;&quot;&gt;.25*ky
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;splay&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;-5
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;spread&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bae67e;&quot;&gt;1.04kx
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;index&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;          &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;key&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;stagger&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bae67e;&quot;&gt;-.65*ky
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;splay&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;-1
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;inner&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;          &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;key&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;stagger&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bae67e;&quot;&gt;-.5*ky
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;rows&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;bottom&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;home&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;top&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;    &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;thumb&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;key&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;padding&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bae67e;&quot;&gt;ky
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;spread&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bae67e;&quot;&gt;kx
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;anchor&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;ref&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#bae67e;&quot;&gt;matrix_index_bottom
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;shift&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;2&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;,&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;-28&lt;&#x2F;span&gt;&lt;span&gt;]
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;columns&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;left&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;          &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;key&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;shift&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;-1&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;,&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;0&lt;&#x2F;span&gt;&lt;span&gt;]
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;splay&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;-15
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;middle&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;          &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;key&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;splay&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;-7&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;5
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;right&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;          &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;key&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;splay&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;-15
&lt;&#x2F;span&gt;&lt;span&gt;            &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;shift&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;: &lt;&#x2F;span&gt;&lt;span&gt;[&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;2&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;.&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;6&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;,&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ffcc66;&quot;&gt;-2&lt;&#x2F;span&gt;&lt;span&gt;]
&lt;&#x2F;span&gt;&lt;span&gt;      &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;rows&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;span&gt;        &lt;&#x2F;span&gt;&lt;span style=&quot;color:#73d0ff;&quot;&gt;cluster&lt;&#x2F;span&gt;&lt;span style=&quot;color:#ccc9c2cc;&quot;&gt;:
&lt;&#x2F;span&gt;&lt;&#x2F;code&gt;&lt;&#x2F;pre&gt;
&lt;p&gt;I used &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x2F;ceoloide&#x2F;ergogen-footprints&#x2F;tree&#x2F;main&quot;&gt;Ceoloide&#x27;s&lt;&#x2F;a&gt; footprint for the switch footprints, which are reversible, meaning that both halves of the board can use the same PCB design.&lt;&#x2F;p&gt;

	&lt;img class=&quot;
			
			
			
			no-hover
                        
		&quot;
		alt=&quot;Preview of layout in ergogen online tool&quot;
		src=&quot;ergogen_preview.png&quot; &#x2F;&gt;
	

&lt;figcaption&gt;Preview of layout generated in Ergogen&lt;&#x2F;figcaption&gt;
&lt;hr &#x2F;&gt;
&lt;h1 id=&quot;pcb-design&quot;&gt;PCB Design&lt;&#x2F;h1&gt;
&lt;p&gt;Ergogen generated a KiCad file with the board outline and switch footprints. I had to create and route the traces. Additionally, the footprint I used for the nRF52840 didn&#x27;t account for its battery pads, so I had to modify the footprint by adding a small cutout to route battery wires through. I haven&#x27;t messed around with PCBs before this besides some basic designs from school, so that was a nice learning experience. The supportive community on the &lt;a href=&quot;https:&#x2F;&#x2F;discord.gg&#x2F;kk4rXYkp4H&quot;&gt;Absolem Club Discord server&lt;&#x2F;a&gt; helped me through the process.&lt;&#x2F;p&gt;

	&lt;img class=&quot;
			
			
			
			no-hover
                        
		&quot;
		
		src=&quot;KiCad_before.png&quot; &#x2F;&gt;
	

&lt;figcaption&gt;The PCB Ergogen generated&lt;&#x2F;figcaption&gt;

	&lt;img class=&quot;
			
			
			
			no-hover
                        
		&quot;
		
		src=&quot;KiCad_after.png&quot; &#x2F;&gt;
	

&lt;figcaption&gt;After adding traces and adjusting the microcontroller footprint&lt;&#x2F;figcaption&gt;
&lt;p&gt;Once all the electronics were in place, I decided to add some decorative patterns to the pcb, as I decided not to use a plate on this keyboard.

	&lt;img class=&quot;
			
			
			
			no-hover
                        
		&quot;
		
		src=&quot;final_pcb.png&quot; &#x2F;&gt;
	


And with that, the PCB design was pretty much done. All that was left was ordering everything and putting it all together.&lt;&#x2F;p&gt;
&lt;h1 id=&quot;assembly-and-firmware&quot;&gt;Assembly and Firmware&lt;&#x2F;h1&gt;
&lt;p&gt;I ordered my PCB from &lt;a href=&quot;https:&#x2F;&#x2F;jlcpcb.com&#x2F;&quot;&gt;JLCPCB&lt;&#x2F;a&gt; in black and white for about 20 USD, the microcontroller from &lt;a href=&quot;https:&#x2F;&#x2F;www.seeedstudio.com&#x2F;&quot;&gt;SeeedStudio&lt;&#x2F;a&gt;, and the other components from &lt;a href=&quot;https:&#x2F;&#x2F;typeractive.xyz&#x2F;&quot;&gt;Typeractive&lt;&#x2F;a&gt;.&lt;&#x2F;p&gt;
&lt;p&gt;I used my university&#x27;s makerspace for soldering, learning about reflow soldering for smaller components.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;keymap&quot;&gt;Keymap&lt;&#x2F;h2&gt;
&lt;p&gt;First, I defined the keymap. I opted for Colemak-DH, as it was designed to be a more ergonomic layout that also allows for faster typing speeds. The other layers were designed by seeing various designs online and then just iterating.&lt;&#x2F;p&gt;
&lt;p&gt;I had initially set out to write the keymap directly to the ZMK keymap file, but I quickly found &lt;a href=&quot;https:&#x2F;&#x2F;nickcoutsos.github.io&#x2F;keymap-editor&#x2F;&quot;&gt;Keymap Editor&lt;&#x2F;a&gt;, an online tool that can connect to a ZMK repository on GitHub and manage the keymaps with a very easy to use GUI. I used the tool to create these keymaps:&lt;&#x2F;p&gt;

	&lt;img class=&quot;
			
			
			
			no-hover
                        
		&quot;
		
		src=&quot;default_layer.png&quot; &#x2F;&gt;
	

&lt;figcaption&gt;Default layer&lt;&#x2F;figcaption&gt;

	&lt;img class=&quot;
			
			
			
			no-hover
                        
		&quot;
		
		src=&quot;symbol_layer.png&quot; &#x2F;&gt;
	

&lt;figcaption&gt;Symbol layer&lt;&#x2F;figcaption&gt;

	&lt;img class=&quot;
			
			
			
			no-hover
                        
		&quot;
		
		src=&quot;number_layer.png&quot; &#x2F;&gt;
	

&lt;figcaption&gt;Number layer&lt;&#x2F;figcaption&gt;

	&lt;img class=&quot;
			
			
			
			no-hover
                        
		&quot;
		
		src=&quot;tri_layer.png&quot; &#x2F;&gt;
	

&lt;figcaption&gt;Function layer&lt;&#x2F;figcaption&gt;

	&lt;img class=&quot;
			
			
			
			no-hover
                        
		&quot;
		
		src=&quot;gaming_layer.png&quot; &#x2F;&gt;
	

&lt;figcaption&gt;Gaming layer&lt;&#x2F;figcaption&gt;
&lt;p&gt;I also decided to make another layer for gaming to keep the WASD layout, but I havent been able to test how effective this is.&lt;&#x2F;p&gt;
&lt;h2 id=&quot;firmware&quot;&gt;Firmware&lt;&#x2F;h2&gt;
&lt;p&gt;I then opted for the ZMK Firmware, namely because QMK does not support wireless boards due to some licensing issues with Bluetooth, and because I do intend on learning Zephyr eventually, which ZMK is based on.&lt;&#x2F;p&gt;
&lt;p&gt;I began by mapping the pins on the microcontroller to the corresponding columns and rows of the keyboard matrix. I probably shouldve planned these before designing the PCB, but I chose these pins retroactively, as the PCB traces were already routed.&lt;&#x2F;p&gt;
&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;Pin Number&lt;&#x2F;th&gt;&lt;th&gt;Digital&lt;&#x2F;th&gt;&lt;th&gt;Matrix mapping&lt;&#x2F;th&gt;&lt;&#x2F;tr&gt;&lt;&#x2F;thead&gt;&lt;tbody&gt;
&lt;tr&gt;&lt;td&gt;P0.02&lt;&#x2F;td&gt;&lt;td&gt;0&lt;&#x2F;td&gt;&lt;td&gt;Outer Column&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;P0.03&lt;&#x2F;td&gt;&lt;td&gt;1&lt;&#x2F;td&gt;&lt;td&gt;Pinky Column&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;P0.28&lt;&#x2F;td&gt;&lt;td&gt;2&lt;&#x2F;td&gt;&lt;td&gt;Middle Column + outerthumb&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;P0.29&lt;&#x2F;td&gt;&lt;td&gt;3&lt;&#x2F;td&gt;&lt;td&gt;Index Column + middlethumb&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;P0.04&lt;&#x2F;td&gt;&lt;td&gt;4&lt;&#x2F;td&gt;&lt;td&gt;Inner Column + innerthumb&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;P1.12&lt;&#x2F;td&gt;&lt;td&gt;7&lt;&#x2F;td&gt;&lt;td&gt;Upper Row&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;P1.13&lt;&#x2F;td&gt;&lt;td&gt;8&lt;&#x2F;td&gt;&lt;td&gt;Middle Row&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;P1.14&lt;&#x2F;td&gt;&lt;td&gt;9&lt;&#x2F;td&gt;&lt;td&gt;Lower Row&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;tr&gt;&lt;td&gt;P1.15&lt;&#x2F;td&gt;&lt;td&gt;10&lt;&#x2F;td&gt;&lt;td&gt;Thumb Row&lt;&#x2F;td&gt;&lt;&#x2F;tr&gt;
&lt;&#x2F;tbody&gt;&lt;&#x2F;table&gt;
&lt;h3 id=&quot;creating-the-shield&quot;&gt;Creating the shield&lt;&#x2F;h3&gt;
&lt;p&gt;Because this keyboard was completely original, there wasnt a pre-existing shield, so I had to make my own. That wasnt so bad. The &lt;a href=&quot;https:&#x2F;&#x2F;zmk.dev&#x2F;docs&#x2F;development&#x2F;new-shield&quot;&gt;ZMK documentation&lt;&#x2F;a&gt; is very well written and easy to follow.&lt;&#x2F;p&gt;
&lt;p&gt;All that was left was to compile and flash the firmware! &lt;small&gt;Not Really&lt;&#x2F;small&gt;&lt;&#x2F;p&gt;
&lt;h1 id=&quot;trouble-in-paradise&quot;&gt;Trouble in Paradise&lt;&#x2F;h1&gt;
&lt;p&gt;Despite the careful planning and assembly, I ran into a significant issue: the left half of the keyboard worked perfectly and paired with my devices, but the right half was unresponsive.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;initial-diagnosis&quot;&gt;Initial Diagnosis&lt;&#x2F;h3&gt;
&lt;p&gt;I tried resetting the firmware, suspecting an issue with the pairing process. This fixed the issue in that the right half now connected, but it also led me to find another problem: most keys on the right half were unresponsive, and pressing the top key in each column caused all keys in that column to ghost.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;physical-troubleshooting&quot;&gt;Physical Troubleshooting&lt;&#x2F;h3&gt;
&lt;p&gt;I grabbed a multimeter to test each diode, as my soldering job for the right half was particularly ugly, but each diode was functioning correctly. Next, I tested each diode-switch pair, where I did find an inconsistency in voltages. I then tried flipping all the diodes, as perhaps the direction needed to be flipped because the board was flipped, but this yielded no change. It was time to take a look at the PCB.&lt;&#x2F;p&gt;
&lt;h3 id=&quot;pcb-analysis&quot;&gt;PCB Analysis&lt;&#x2F;h3&gt;
&lt;p&gt;I next decided to take a look at the PCB layout. This is where I found the culprit. I discovered that I had forgotten to route one of the pads on the backside (the front for the right side of the board). Fortunately, because the left and right halves of the board use the same PCB, I was able to simply resolder the microcontroller to the back side of the right half. I knew this would work because the left side worked flawlessly, and although the diode pads were on the other side, all the switch connections were through-holes, so the side on which they were installed would not matter. All that was left was to compensate with software by reversing the order of the pins. This finally worked.&lt;&#x2F;p&gt;
&lt;h1 id=&quot;conclusion&quot;&gt;Conclusion&lt;&#x2F;h1&gt;
&lt;p&gt;This project was a bit challenging but very rewarding, providing me with a custom mechanical keyboard tailored to my preferences. It was also my first truly original electronics project, and it taught me a lot about PCB design and soldering, all through practical hands-on experience. This project also helped in refining my independent problem-solving skills, as I am used to having either documentation or peers to take help from. I hope this inspires others to try their hand at DIY keyboard building!&lt;&#x2F;p&gt;
&lt;h2 id=&quot;open-source&quot;&gt;Open Source (?)&lt;&#x2F;h2&gt;
&lt;p&gt;I&#x27;ve finally open sourced the keyboard design files on &lt;a class=&quot;external&quot; href=&quot;https:&#x2F;&#x2F;github.com&#x2F;samienr&#x2F;SOR-Hydrogen&quot;&gt;this Github repository.&lt;&#x2F;a&gt; I haven&#x27;t yet fixed the PCB routing mistake, though I do plan on getting to it eventually. It&#x27;s just not a high priority at the moment. Feel free to do whatever you want with the designs, this project was more for the learning experience.&lt;&#x2F;p&gt;
&lt;h1 id=&quot;next-steps&quot;&gt;Next Steps&lt;&#x2F;h1&gt;
&lt;p&gt;I&#x27;m probably going to work on a case for the boards next. The goal as it stands now is to create a model for 3D printing just to protect the boards (and the surfaces I put them on), then to eventually design a case for either CNC milling or resin printing that holds the boards at the most comfortable angles for me.&lt;&#x2F;p&gt;

	&lt;img class=&quot;
			
			
			
			
                        
		&quot;
		
		src=&quot;keyboard.jpg&quot; &#x2F;&gt;
	

&lt;figcaption&gt;The completed product&lt;&#x2F;figcaption&gt;
</description>
      </item>
    </channel>
</rss>
