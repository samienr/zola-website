<!doctype html><html lang=en xmlns=http://www.w3.org/1999/xhtml><head><meta charset=UTF-8><meta content=Nerd name=description><meta content="width=device-width,initial-scale=1" name=viewport><meta content="rgb(101, 143, 239)" name=theme-color><meta content="rgb(140, 170, 238)" media=(prefers-color-scheme:dark) name=theme-color><title>How The Nintendo 3DS Was Hacked Using a Music File - samienr</title><link href=https://samienr.com/blog/soundhax/ rel=canonical><link href=https://samienr.com/favicon.png rel=icon type=image/png><link href=https://samienr.com/apple-touch-icon.png rel=apple-touch-icon sizes=180x180 type=image/png><link title="samienr - RSS Feed" href=https://samienr.com/rss.xml rel=alternate type=application/rss+xml><link title="samienr - Atom Feed" href=https://samienr.com/atom.xml rel=alternate type=application/atom+xml><style>:root{--accent-color:#658fef;--contrast-color:#fff}[data-theme=dark]{--accent-color:#8caaee}@media (prefers-color-scheme:dark){:root:not([data-theme=light]){--accent-color:#8caaee}}</style><link href=https://samienr.com/style.css rel=stylesheet><link href=https://samienr.com/footer.css rel=stylesheet><link href=https://samienr.com/typography.css rel=stylesheet><script defer src=https://samienr.com/closable.js></script><script defer src=https://samienr.com/copy-button.js></script><script defer src=https://samienr.com/elasticlunr.min.js></script><script defer src=https://samienr.com/search-elasticlunr.js></script><meta content=samienr property=og:site_name><meta content="How The Nintendo 3DS Was Hacked Using a Music File - samienr" property=og:title><meta content=https://samienr.com/blog/soundhax/ property=og:url><meta content="A deep dive into the SoundHax exploit" property=og:description><meta content=https://samienr.com/card.png property=og:image><meta content=en_US property=og:locale><body><header id=site-nav><nav><a href=#main-content tabindex=0> Skip to Main Content </a><ul><li id=home><a href=https://samienr.com> <i class=icon></i>samienr</a><li class=divider><li><a href=https://samienr.com/about/>About</a><li><a href=https://samienr.com/blog/>Blog</a><li><a href=https://samienr.com/contact/>Contact</a><li id=search><button class=circle id=search-toggle title=Search><i class=icon></i></button></ul></nav><div id=search-container><label class=visually-hidden for=search-bar>Search</label><input placeholder="Search for…" autocomplete=off disabled id=search-bar type=search><div id=search-results-container><div id=search-results></div></div></div></header><main id=main-content><div id=breadcrumb-container><a class=breadcrumb-path href=/>Home</a><span class=breadcrumb-separator> > </span><a class=breadcrumb-path href=https://samienr.com/blog/>Blog</a><span class=breadcrumb-separator> > </span><a class="breadcrumb-path active" id=active-page>How The Nintendo 3DS Was Hacked Using a Music File</a></div><article><div id=heading><p><small> <time datetime=" 2024-09-17T00:00:00+00:00">Published on September 17, 2024</time></small><h1>How The Nintendo 3DS Was Hacked Using a Music File</h1><p><small><span>2 minutes read</span></small></div><div id=buttons-container><details class=closable id=toc><summary title="Table of Contents"><i class=icon></i></summary> <div><strong class=title>Table of Contents</strong><div><ul><li><a href=https://samienr.com/blog/soundhax/#the-vulnerability>The Vulnerability</a><ul><li><a href=https://samienr.com/blog/soundhax/#the-exploit-chain>The Exploit Chain</a></ul><li><a href=https://samienr.com/blog/soundhax/#1-attack-plan>1. Attack Plan</a></ul></div></div></details><a title="Go to Top" href=#top id=go-to-top><i class=icon></i></a><a title="File an Issue" href=https://github.com/samienr/zola-website/issues id=issue><i class=icon></i></a></div><p><a href=https://soundhax.com>SoundHax</a> was one of the most accessible exploits to get unsigned code running on the Nintendo 3DS. It worked by abusing a bug found in the <em>Nintendo 3DS Sound</em> application with a specially-crafted <code>.m4a</code> file.<p>The exploit is special as it was the first exploit on the 3DS that was free, offline, and worked on every version of the firmware as of when SoundHax was launched.<p>To fully appreciate this brilliant symphony of hacks, a basic understanding of <a href=https://samienr.com/blog/soundhax/memory>memory management</a> is recommended.<p><small>Before proceeding, I'd also highly suggest reading the writeup on <a href="https://github.com/nedwill/soundhax?tab=readme-ov-file#writeup">Nedwill's GitHub page</a></small><hr><h2 id=the-vulnerability>The Vulnerability</h2><p>At its core, SoundHax exploits a bug in how the 3DS Sound application handles MP4 atom tags:<ol><li>A 256-byte buffer is allocated for song names (the maxsize according to the MP4 spec). <ul><li>The song name is then copied from the file into the buffer using one of two functions.</ul><li>For ASCII strings, <code>strncpy(dst, src, 256)</code> is used, which is safe.<li>For Unicode strings, <code>memcpy</code> is used, which <strong>takes a user-provided size</strong> instead of 256 <small>(not safe!)</small>.</ol><p>This was likely because <code>strncpy</code> stops at the first null terminating byte <small>(which works for ASCII strings)</small>. As Unicode can have null bytes as parts of characters, <code>strncpy</code> wouldn't work well.<p>Instead, song names are simply gathered by copying over as many bytes as the file specifies, even if the number is greater than 256.<p>This means that the program code is vulnerable to a <colorize><strong>buffer overflow attack.</strong></colorize> By providing a carefully crafted Unicode title longer than 256 bytes, an attacker can write data beyond the allocated buffer and into other parts of console memory.<h3 id=the-exploit-chain>The Exploit Chain</h3><p>Taking advantage of this bug, we can get arbitrary code execution on the 3DS using the following steps:<ol><li>Crafted M4A file with oversized Unicode title<li>Buffer overflow in heap<li>Heap manipulation (fake chunk creation)<li>Unlink exploitation<li>Arbitrary write primitive<li>ROP chain setup<li>gspwn GPU exploit<li>Code execution</ol><p>Anyways, here's how it works.<h1 id=1-attack-plan>1. Attack Plan</h1><p>The goal is to create a specially crafted <code>.m4a</code> "audio" file with an oversized Unicode title to overflow the heap.</article><hr><nav id=post-nav><a class="post-nav-item post-nav-prev" href=https://samienr.com/blog/keyboard/> <div class=nav-arrow>Previous</div> <span class=post-title>How I Designed My First Custom Keyboard</span> </a></nav><span class=hidden id=copy-code-text>Copy Code</span><span class=hidden id=search-index>https://samienr.com/search_index.en.json</span><span class=hidden id=more-matches-text>$MATCHES more matches</span></main><footer id=site-footer><nav><ul><li><a href=https://samienr.com/notebook/>Notebook</a><li><a href=https://samienr.com/photography/>Photography</a></ul></nav><p>© samienr, 2024</footer>